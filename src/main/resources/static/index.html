<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" href="css/common.css">

</head>
<body>
    <div class="contents">
        <div class="filter">
            <label>완료 여부</label>
            <select >
                <option>전체</option>
                <option>완료</option>
                <option>미완료</option>
            </select>
            <input type="text"> <button class="button">검색</button>
        </div>
        <div class="list">
<!--            <dl class="card add">-->
<!--                <button> + </button>-->
<!--            </dl>-->
             <dl class="card add-box" id="create-card">
                <dt>
                    <input type="text" placeholder="Content" id="create-content"> <button class="button" id="create-btn">등록</button>
                    <div class="button">
                        <div  class="close"></div>
                    </div>
                </dt>
                <dd><label class="sub-title">참조카드</label><input type="text" placeholder="카드ID ,로 연결" id="create-ref"></dd>
            </dl>
            <dl class="card" data-id="1">
                <label class="id">@1</label>
                <dt>
                    <input type="checkbox" id="ck_1">
                    <label >TODO 1</label>
                    <div class="button">
                        <div  class="edit"></div>
                        <div  class="close"></div>
                    </div>
                </dt>
                <dd>작성일 : <label>2020-04-15</label> | 최종수정일 : <label>2020-04-15</label></dd>
            </dl>

            <dl class="card" data-id="2">
                <label class="id">@2</label>
                <dt>
                    <input type="checkbox" id="ck_2">
                    <label >TODO 2</label>
                    <div class="button">
                        <div  class="edit"></div>
                        <div  class="close"></div>
                    </div>
                </dt>
                <dd>@1</dd>  <dd>@3</dd>
                <dd>작성일 : <label>2020-04-15</label> | 최종수정일 : <label>2020-04-15</label></dd>
            </dl>
            <dl class="card" data-id="3">
                <label class="id">@3</label>
                <dt>
                    <input type="checkbox" id="ck_3">
                    <label >TODO 1</label>
                    <div class="button">
                        <div  class="edit"></div>
                        <div  class="close"></div>
                    </div>
                </dt>
                <dd>작성일 : <label>2020-04-15</label> | 최종수정일 : <label>2020-04-15</label></dd>
            </dl>
            <dl class="card add-box" data-id="4">
                <label class="id">@4</label>
                <dt>
                    <input type="checkbox" id="ck_4">
                    <input type="text" placeholder="Title" value="TODO 4">
                    <div class="button">
                        <div  class="save"></div>
                        <div  class="close"></div>
                    </div>
                </dt>
                <dd><label class="sub-title">카드 연결</label><input type="text" value="1,3"></dd>
                <!--<dd>@1</dd>  <dd>@3</dd>-->
                <dd>작성일 : <label>2020-04-15</label> | 최종수정일 : <label>2020-04-15</label></dd>
            </dl>
        </div>
    </div>
<script type="application/javascript">

    function load(){
        $.ajax({
            url:'/item/list',
            type:'GET',
            dataType: 'json',
            contentType : 'application/json',
            // data: JSON.stringify({
            //     url : $('#url').val().trim()
            // }),
            success:function(data){
                // $('#resBox').removeClass("none").addClass("show");
                // $('#changeUrl').text(data.changeUrl);
                // $('#reqCnt').text(data.reqCnt);
                console.log(data)
            },
            error:function () {
               alert("로드실패");
            }
        })

    }

    function validRef(e) {
        let itemsString = $('#create-ref').val();

        if(itemsString != '') {
            let check = true;
            itemsString.split(',').forEach((value, index) => {
                if (isNaN(value)){
                    check = false;
                }
            });
            if(check){
               return $.map( itemsString.split(','), Number );
            }else {
                alert("참조 카드ID는 숫자만 입력 가능합니다.");
                return false;
            }
        } else{
            return [];
        }

    }

    function createCardEvent(){
        if( $('#create-content').val() .trim() ==='')  return false;
        let refItems = validRef();
        if(refItems === false) return false;

        $.ajax({
            url:'/item',
            type:'POST',
            dataType: 'json',
            contentType : 'application/json',
            data: JSON.stringify({
                content : $('#create-content').val() .trim(),
                refItems : refItems
            }),
            success : function(data){
                $('#create-content').val('');
                $('#create-ref').val('');
                load();
            },
            error : function (data) {
                alert(data.responseJSON.message);
            }
        })
    }

    function statusUpdateEvent(){
        let ck = $(this);
        let ckId = ck.prop('id');
        let cardId = ckId.split('_')[1];
        let complete = ck.prop('checked');
        $.ajax({
            url:'/item/'+cardId+'?complete='+complete,
            type:'PUT',
            success : function(data){
                load();
            },
            error : function (data) {
                ck.prop('checked', !complete);
                alert(data.responseJSON.message);

            }
        })
    }

    function cardDeleteEvent(){
        let card = $(this).parents('dl');
        let cardId = card.data('id');;
        let result = confirm("@"+ cardId +"을(를) 삭제하시겠습니까?");
          if(result){
              $.ajax({
                  url:'/item/'+cardId,
                  type:'DELETE',
                  success : function(data){
                      load();
                  },
                  error : function (data) {
                      alert(data.responseJSON.message);
                  }
              })
          }
    }


    $(document).on('click','.card input[type=checkbox]', statusUpdateEvent);
    $(document).on('click','.card .button .close', cardDeleteEvent);


    $('#create-btn').click(createCardEvent);
    load();

</script>

</body>
</html>